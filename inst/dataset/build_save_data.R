require(rgdal)
require(sp)

# http://www.naturalearthdata.com/downloads/

#----------------
# countries - 50m
#----------------

# country_50m <- readOGR(dsn = "C:\\Users\\Datastorm\\Downloads\\50m_cultural",
#                        layer = "ne_50m_admin_0_countries")
#
# summary(country_50m)
#
# # keep only Europe
# country_50m <- country_50m[country_50m$continent%in% "Europe", ]
#
# # subset on some columns
# europe_countries_50m <- country_50m[, c("name", "name_long", "admin", "adm0_a3",
#                                         "adm0_a3_is","adm0_a3_us", "type",  "subunit",
#                                         "su_a3", "pop_est", "pop_year", "continent", "region_un",
#                                         "subregion",  "sovereignt")]
#
# summary(europe_countries_50m)
#
# # save as rda
# devtools::use_data(europe_countries_50m, overwrite = T)

# saveRDS(country_50m, file = "inst/dataset/maps/europe_countries_50m.RDS", overwrite = T)

#----------------
# countries - 10m
#----------------

# country_10m_map <- readOGR(dsn = "C:\\Users\\BenoitThieurmel\\Downloads\\ne_10m_admin_0_map_units",
#                        layer = "ne_10m_admin_0_map_units")
# 
# country_10m_ref <- readOGR(dsn = "C:\\Users\\BenoitThieurmel\\Downloads\\ne_10m_admin_0_countries",
#                        layer = "ne_10m_admin_0_countries")

country_10m_map <- readOGR(dsn = "C:\\Users\\BenoitThieurmel\\Downloads\\ne_50m_admin_0_map_units",
                           layer = "ne_50m_admin_0_map_units")

colnames(country_10m_map@data) <- tolower(colnames(country_10m_map@data))

plot(country_10m_map[country_10m_map$name_long %in% "Greece",])

plot(country_10m_map[country_10m_map$name_long %in% c("Western Sahara"),])
plot(country_10m_map[country_10m_map$name_long %in% c("Morocco", "Mauritania", "Western Sahara"),])
# country_10m_ref <- readOGR(dsn = "C:\\Users\\Datastorm\\Downloads\\50m_cultural",
#                            layer = "ne_50m_admin_0_countries")
# keep only Europe + Turquie + now Africa

unique(country_10m_map$continent)
sort(unique(country_10m_map$name_long))
add_ct <- c("Turkey", 
            "Cyprus", 
            "Federation of Bosnia and Herzegovina",
            "Algeria", 
            "Egypt",
            "Israel",
            "Iran",
            "Iraq",
            "Jordan",
            "Lebanon",
            "Libya",
            "Morocco",
            "Saudi Arabia",
            "Syria",
            "Tunisia",
            "United Arab Emirates",
            "Qatar",
            "Gaza", 
            "Mauritania", 
            "Mali", 
            "Kuwait", 
            "Bahrain", 
            "Oman", 
            "Yemen",
            "Georgia", 
            "Armenia",
            "Azerbaijan"
)

country_10m <- country_10m_map[country_10m_map$continent %in% c("Europe", "Africa") | 
                                 country_10m_map$name_long %in% add_ct, ]

plot(country_10m)

plot(country_10m_map[country_10m_map$name_long %in% c("Azerbaijan"),])
plot(country_10m_map[country_10m_map$name_long %in% c("Armenia"),])
plot(country_10m_map[country_10m_map$name_long %in% c("Georgia"),])
plot(country_10m_map[country_10m_map$name_long %in% c("Yemen"),])
plot(country_10m_map[country_10m_map$name_long %in% c("Oman"),])
plot(country_10m_map[country_10m_map$name_long %in% c("Bahrain"),])
plot(country_10m_map[country_10m_map$name_long %in% c("Kuwait"),])
plot(country_10m_map[country_10m_map$name_long %in% c("Mauritania"),])
plot(country_10m_map[country_10m_map$name_long %in% c("Mali"),])

# Kosovo : fusion avec la Serbia
plot(country_10m[country_10m$name_long %in% "Serbia",])
plot(country_10m[country_10m$name_long %in% c("Serbia", "Kosovo", "Vojvodina"),])

country_10m_serbie <- country_10m_map[country_10m_map$name_long %in% c("Serbia", "Kosovo", "Vojvodina"), ]
country_10m_serbie@data$adm0_a3_is <- "SRB"
country_10m_serbie <- raster::aggregate(country_10m_serbie, by = c("adm0_a3_is"))
plot(country_10m_serbie)

slot(country_10m, "polygons")[[which(country_10m$name_long %in% "Serbia")]] <- slot(country_10m_serbie, "polygons")[[1]]
plot(country_10m[country_10m$name_long %in% "Serbia",])

# and so rm kosovo & "Vojvodina"
plot(country_10m[country_10m$name_long %in% c("Kosovo", "Vojvodina"), ])
country_10m <- country_10m[!country_10m$name_long %in% c("Kosovo", "Vojvodina"), ]

# merge "Morocco" & "Western Sahara" = "Morocco
plot(country_10m_map[country_10m_map$name_long %in% c("Western Sahara", "Morocco"),])

country_10m_mor <- country_10m_map[country_10m_map$name_long %in% c("Western Sahara", "Morocco"), ]
country_10m_mor <- raster::aggregate(country_10m_mor, by = c("adm0_a3_is"), fun = "min")
country_10m_mor <- rgeos::gSimplify(country_10m_mor, tol=0.09)

slot(country_10m, "polygons")[[which(country_10m$name_long %in% "Morocco")]] <- slot(country_10m_mor, "polygons")[[1]]

plot(country_10m[country_10m$name_long %in% "Morocco",])
country_10m <- country_10m[!country_10m$name_long %in% "Western Sahara", ]

# merge Gaza et West Bank = Palestine
plot(country_10m_map[country_10m_map$name_long %in% c("West Bank", "Gaza"),])

country_10m_pal <- country_10m_map[country_10m_map$name_long %in% c("West Bank", "Gaza"), ]
country_10m_pal <- raster::aggregate(country_10m_pal, by = c("adm0_a3_is"))
plot(country_10m_pal)

slot(country_10m, "polygons")[[which(country_10m$name_long %in% "Gaza")]] <- slot(country_10m_pal, "polygons")[[1]]
country_10m@data$name <- as.character(country_10m@data$name)
country_10m@data$name_long <- as.character(country_10m@data$name_long)
country_10m@data$name[country_10m$name_long %in% "Gaza"] <- "Palestine"
country_10m@data$name_long[country_10m$name_long %in% "Gaza"] <- "Palestine"

plot(country_10m[country_10m$name_long %in% "Palestine",])

#-----------------------
# isolation de la corse
country_10m_fr <- country_10m_map[country_10m_map$name_long %in% "France",]

country_10m_fr_pol <- raster::disaggregate(country_10m_fr)
plot(country_10m_fr_pol[1, ])
plot(country_10m_fr_pol[2, ])
plot(country_10m_fr_pol[3, ])

# modification de la France
slot(country_10m, "polygons")[[which(country_10m$name_long %in% "France")]] <- slot(country_10m_fr_pol, "polygons")[[2]]
plot(country_10m[country_10m$name_long %in% "France",])

# creation de la corse
sp_corse <- country_10m_map[country_10m_map$name_long %in% "France",]
slot(sp_corse, "polygons")[[which(sp_corse$name_long %in% "France")]] <- slot(country_10m_fr_pol, "polygons")[[1]]

sp_corse@data[, c("name", "admin", "adm0_a3",
                  "adm0_a3_is","adm0_a3_us",
                  "type",  "subunit",
                  "continent", "region_un",
                  "subregion",  "sovereignt")]

sp_corse@data$name <- "Corsica"
sp_corse@data$name_long <- "Corsica"
sp_corse@data$admin <- "Corsica"
sp_corse@data$adm0_a3 <- "COR"
sp_corse@data$adm0_a3_is <- "COR"
sp_corse@data$adm0_a3_us <- "COR"

country_10m <- rbind(country_10m, sp_corse)

plot(country_10m)
plot(country_10m[country_10m$name_long %in% "France",])
plot(country_10m[country_10m$name_long %in% "Corsica",])

#-----------------------
# isolation de la crete
country_10m_gr <- country_10m_map[country_10m_map$name_long %in% "Greece",]

plot(country_10m_gr)
country_10m_gr_pol <- raster::disaggregate(country_10m_gr)

# for(i in 1:nrow(country_10m_gr_pol)){
#   par(ask = T)
#   plot(country_10m_gr_pol[i, ], main = i)
# }

# modification de la grece
sp_greece <- raster::aggregate(country_10m_gr_pol[-39,])
slot(country_10m, "polygons")[[which(country_10m$name_long %in% "Greece")]] <- slot(sp_greece, "polygons")[[1]]
plot(country_10m[country_10m$name_long %in% "Greece",])

# creation de la crete
sp_crete <- country_10m_map[country_10m_map$name_long %in% "Greece",]
slot(sp_crete, "polygons")[[which(sp_crete$name_long %in% "Greece")]] <- slot(country_10m_gr_pol, "polygons")[[39]]

sp_crete@data[, c("name", "admin", "adm0_a3",
                  "adm0_a3_is","adm0_a3_us",
                  "type",  "subunit",
                  "continent", "region_un",
                  "subregion",  "sovereignt")]

sp_crete@data$name <- "Creete"
sp_crete@data$name_long <- "Creete"
sp_crete@data$admin <- "Creete"
sp_crete@data$adm0_a3 <- "CRT"
sp_crete@data$adm0_a3_is <- "CRT"
sp_crete@data$adm0_a3_us <- "CRT"

country_10m <- rbind(country_10m, sp_crete)

plot(country_10m)
plot(country_10m[country_10m$name_long %in% "Greece",])
plot(country_10m[country_10m$name_long %in% "Creete",])

# chypre : fusion avec la chypre du nord
plot(country_10m_map[country_10m_map$name_long %in% "Cyprus",])
plot(country_10m_map[country_10m_map$name_long %in% "Northern Cyprus",])
plot(country_10m[country_10m$name_long %in% "Northern Cyprus",])

country_10m_cyprus <- country_10m_map[country_10m_map$name_long %in% c("Cyprus", "Northern Cyprus"), ]
country_10m_cyprus <- raster::aggregate(country_10m_cyprus, by = c("adm0_a3_is"))
plot(country_10m_cyprus)

slot(country_10m, "polygons")[[which(country_10m$name_long %in% "Cyprus")]] <- slot(country_10m_cyprus, "polygons")[[1]]
plot(country_10m[country_10m$name_long %in% "Cyprus",])

# remove canaries from spain
# plot(country_10m[country_10m$adm0_a3 %in% "ESP",])
pols_esp <- slot(country_10m, "polygons")[[which(country_10m$adm0_a3 %in% "ESP")]]

sum_area <- 0
# min_lat <- NA
# max_lat <- NA
# min_lon <- NA
# max_lon <- NA
keep_polygons <- sapply(country_10m[country_10m$adm0_a3 %in% "ESP", ]@polygons[[1]]@Polygons, function(x){
  # canaries : lattitude < 30
  if(x@labpt[2] > 30){
    sum_area <<- sum_area + x@area
    # min_lon <<- min(min_lon, x@coords[, 1], na.rm = T)
    # min_lat <<- min(min_lat, x@coords[, 2], na.rm = T)
    # max_lon <<- max(max_lon, x@coords[, 1], na.rm = T)
    # max_lat <<- max(max_lat, x@coords[, 2], na.rm = T)   
  }
  x@labpt[2]>30
})

# new_bbox <- matrix(c(min_lon, max_lon, min_lat, max_lat), nrow = 2, ncol = 2, byrow = T, 
#                    dimnames = list(c("x", "y"), c("min", "max")))

new_order <- country_10m[country_10m$adm0_a3 %in% "ESP", ]@polygons[[1]]@plotOrder[which(keep_polygons)] 
new_order[order(new_order)] <- 1:length(new_order)

slot(pols_esp, "area") <- sum_area
slot(pols_esp, "plotOrder") <- new_order
slot(pols_esp, "Polygons") <- country_10m[country_10m$adm0_a3 %in% "ESP", ]@polygons[[1]]@Polygons[which(keep_polygons)] 

# bug leaflet : have to reset comment...
comment(pols_esp) <- rgeos::createPolygonsComment(pols_esp)
slot(country_10m, "polygons")[[which(country_10m$adm0_a3 %in% "ESP")]] <- pols_esp 

plot(country_10m[country_10m$adm0_a3 %in% "ESP",])

# remove dom-tom from holland
plot(country_10m[country_10m$adm0_a3 %in% "NLD",])
pols_ndl <- slot(country_10m, "polygons")[[which(country_10m$adm0_a3 %in% "NLD")]]

sum_area <- 0
# min_lat <- NA
# max_lat <- NA
# min_lon <- NA
# max_lon <- NA
keep_polygons <- sapply(country_10m[country_10m$adm0_a3 %in% "NLD", ]@polygons[[1]]@Polygons, function(x){
  # print(x@labpt)
  if(x@labpt[2] > 40){
    sum_area <<- sum_area + x@area
    # min_lon <<- min(min_lon, x@coords[, 1], na.rm = T)
    # min_lat <<- min(min_lat, x@coords[, 2], na.rm = T)
    # max_lon <<- max(max_lon, x@coords[, 1], na.rm = T)
    # max_lat <<- max(max_lat, x@coords[, 2], na.rm = T)
  }
  x@labpt[2]>40
})


new_order <- country_10m[country_10m$adm0_a3 %in% "NLD", ]@polygons[[1]]@plotOrder[which(keep_polygons)] 
new_order[order(new_order)] <- 1:length(new_order)

slot(pols_ndl, "area") <- sum_area
slot(pols_ndl, "plotOrder") <- new_order
slot(pols_ndl, "Polygons") <- country_10m[country_10m$adm0_a3 %in% "NLD", ]@polygons[[1]]@Polygons[which(keep_polygons)] 

# bug leaflet : have to reset comment...
comment(pols_ndl) <- rgeos::createPolygonsComment(pols_ndl)
slot(country_10m, "polygons")[[which(country_10m$adm0_a3 %in% "NLD")]] <- pols_ndl 

plot(country_10m[country_10m$adm0_a3 %in% "NLD",])

# subset on columns
europe_countries_10m <- country_10m[, c("name", "admin", "adm0_a3",
                                        "adm0_a3_is","adm0_a3_us",
                                        "type",  "subunit",
                                        "continent", "region_un",
                                        "subregion",  "sovereignt")]
summary(europe_countries_10m)
plot(europe_countries_10m)

names(europe_countries_10m) <- gsub("^adm0_a3$", "code", names(europe_countries_10m))

# ref table
europe_countries_ref <- unique(data.frame(europe_countries_10m[, c("admin", "code")],
                                          stringsAsFactors = F))
colnames(europe_countries_ref) <- c("name", "code")


#----------------
# states - 10m
#----------------
#
# states_10m <- readOGR(dsn = "C:\\Users\\Datastorm\\Downloads\\10m_cultural\\10m_cultural",
#                       layer = "ne_10m_admin_1_states_provinces_shp")

states_10m <- readOGR(dsn = "C:\\Users\\BenoitThieurmel\\Downloads\\ne_10m_admin_1_states_provinces_lakes",
                      layer = "ne_10m_admin_1_states_provinces_lakes")
colnames(states_10m@data) <- tolower(colnames(states_10m@data))

ind_diff <- which(states_10m@data$sov_a3 != states_10m@data$adm0_a3)

sort(unique(states_10m@data$admin))
View(states_10m@data[ind_diff, ])
add_ct <- c("Turkey", 
            "Cyprus", 
            "Northern Cyprus",
            "Kosovo",
            "Federation of Bosnia and Herzegovina",
            "Algeria", 
            "Egypt",
            "Israel",
            "Iran",
            "Iraq",
            "Jordan",
            "Lebanon",
            "Libya",
            "Morocco",
            "Western Sahara",
            "Saudi Arabia",
            "Syria",
            "Tunisia",
            "United Arab Emirates",
            "Qatar",
            "Mauritania", 
            "Mali", 
            "Kuwait", 
            "Bahrain", 
            "Oman", 
            "Yemen",
            "Georgia", 
            "Armenia",
            "Azerbaijan"
)

# subset on Europe
states_10m_europe <- states_10m[states_10m$adm0_a3%in% europe_countries_10m$code | 
                                  states_10m$admin %in% add_ct, ]
summary(states_10m_europe)

plot(states_10m_europe)


# Kosovo : fusion avec la Serbia
states_10m_europe@data[states_10m_europe$admin %in% c("Kosovo", "Republic of Serbia"), ]
plot(states_10m_europe[states_10m_europe$admin %in% c("Republic of Serbia"), ])
plot(states_10m_europe[states_10m_europe$admin %in% c("Kosovo"), ])

states_10m_europe$admin <- gsub("Kosovo", "Republic of Serbia", states_10m_europe$admin)
states_10m_europe$adm0_a3 <- gsub("^KOS$", "SRB", states_10m_europe$adm0_a3)

plot(states_10m_europe[states_10m_europe$admin %in% c("Republic of Serbia"), ])

# chypre : fusion avec la chypre du nord
plot(states_10m_europe[states_10m_europe$admin %in% c("Cyprus"), ])
plot(states_10m_europe[states_10m_europe$admin %in% c("Northern Cyprus"), ])

states_10m_europe$admin <- gsub("Northern Cyprus", "Cyprus", states_10m_europe$admin)
states_10m_europe$adm0_a3 <- gsub("^CYN$", "CYP", states_10m_europe$adm0_a3)

plot(states_10m_europe[states_10m_europe$admin %in% c("Cyprus"), ])

# maroc : fusion avec western sahara
plot(states_10m_europe[states_10m_europe$admin %in% c("Morocco"), ])
plot(states_10m_europe[states_10m_europe$admin %in% c("Western Sahara"), ])
states_10m_europe$admin <- gsub("Western Sahara", "Morocco", states_10m_europe$admin)
states_10m_europe$adm0_a3 <- gsub("^SAH$", "MAR", states_10m_europe$adm0_a3)

plot(states_10m_europe[states_10m_europe$admin %in% c("Morocco"), ])

# remove islands & corsica from france
plot(states_10m_europe[states_10m_europe$adm0_a3 %in% "FRA", ])
states_10m_europe <- states_10m_europe[!(states_10m_europe$adm0_a3 %in% "FRA" &  !states_10m_europe$type_en %in% "Metropolitan department") &
                                           !states_10m_europe$region %in% "Corse", ]
plot(states_10m_europe[states_10m_europe$adm0_a3 %in% "FRA", ])

# remove creete from greece
plot(states_10m_europe[states_10m_europe$adm0_a3 %in% "GRC", ])
states_10m_europe <- states_10m_europe[!states_10m_europe$name_alt %in% "Crete", ]
plot(states_10m_europe[states_10m_europe$adm0_a3 %in% "GRC", ])

# N0R
View(states_10m_europe@data[states_10m_europe$adm0_a3 %in% "NOR", ])
plot(states_10m_europe[states_10m_europe$adm0_a3 %in% "NOR", ])
states_10m_europe <- states_10m_europe[!(states_10m_europe$adm0_a3 %in% "NOR" & !states_10m_europe$type_en %in% "County"), ]
plot(states_10m_europe[states_10m_europe$adm0_a3 %in% "NOR", ])

# NLD
plot(states_10m_europe[states_10m_europe$adm0_a3 %in% "NLD", ])
states_10m_europe <- states_10m_europe[!(states_10m_europe$adm0_a3 %in% "NLD" & !states_10m_europe$type_en %in% "Province"), ]
plot(states_10m_europe[states_10m_europe$adm0_a3 %in% "NLD", ])

# ESP
View(states_10m_europe@data[states_10m_europe$adm0_a3 %in% "ESP", ])
plot(states_10m_europe[states_10m_europe$adm0_a3 %in% "ESP", ])
states_10m_europe <- states_10m_europe[!(states_10m_europe$adm0_a3 %in% "ESP" & states_10m_europe$region %in% "Canary Is."), ]
plot(states_10m_europe[states_10m_europe$adm0_a3 %in% "ESP", ])

# for(co in europe_countries_ref$code){
#   print(co)
#   par(ask = T)
#   plot(states_10m_europe[!states_10m_europe$sr_adm0_a3 %in% co, ])
# }

# subset on columns
europe_states_provinces_10m <- states_10m_europe[, c("admin", "adm0_a3", "sov_a3", "adm1_code",
                                                     "name", "type", "type_en", "region")]
summary(europe_states_provinces_10m)

names(europe_states_provinces_10m) <- gsub("^adm0_a3$", "code", names(europe_states_provinces_10m))

usethis::use_data(europe_countries_10m, europe_countries_ref, 
                   europe_states_provinces_10m, internal = TRUE, overwrite = T)


#------------------------------------------------------------------------------------------#

library(antaresViz)
library(spMaps)

##comparaison de plusieurs graphiques
pathS2<-"C:\\Users\\Datastorm\\Desktop\\antares\\test_case"
setSimulationPath(pathS2,-1)
myData1<-readAntares(areas = "all", links = "all")

ml<-mapLayout(readLayout())
plotMap(myData1, ml)

plotMapLayout(ml)

#-------------------
# Identify leaflet bug with Spain
#-------------------

require(leaflet)

map=getSpMaps(countries = c("ESP"))

str(map[map$name %in% 'France',])
str(map[map$name %in% 'Spain',])

s <- sp::polygons(map)

plot(s)

map = getSpMaps(countries = c("all"))
leaflet(map) %>% addPolygons()
# 
# leaflet:::derivePolygons
# leaflet:::polygonData.SpatialPolygons
# leaflet:::polygonData(s)
# 
# leaflet:::sp_bbox(s)
# leaflet:::to_multipolygon_list.SpatialPolygons
# 
# pgons <- s@polygons[[1]]
# comment(pgons)
# rgeos::createPolygonsComment(pgons)
# leaflet:::to_multipolygon.Polygons
# lapply(pgons@polygons, to_multipolygon)
# 
# str(s)
# s@polygons
# pgons = leaflet:::derivePolygons(map, lng = NULL, lat = NULL, T, T, 
#                        "addPolygons")
# 